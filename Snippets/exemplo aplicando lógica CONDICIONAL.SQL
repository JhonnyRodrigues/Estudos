-- REGRA DE NEGÓCIO: SE ((NIVEL 2 OU 3) E (NIVEL 1 E SITUACAO 1)); ENTÃO MOSTRAR APENAS REGISTROS NIVEL 1

SELECT
    A.ID_ASSINATURA AS ID_ASSINATURA,
    A.FK_ASSINANTE AS FK_ASSINANTE,
    A.SITUACAO AS SITUACAO,
    A.NIVEL AS NIVEL,
    A.REVISAR AS REVISAR,
    A.DATA_ENCAMINHAMENTO AS DATA_ENCAMINHAMENTO,
    A.DATA_ASSINATURA AS DATA_ASSINATURA,
    A.MOTIVO AS MOTIVO,
    A.FK_DEMANDA AS FK_DEMANDA,
    D.CODIGO_COMPLETO_MATERIAL AS CODIGO_DEMANDA,
    D.SUBGRUPO_CODIGO AS SUBGRUPO_CODIGO,
    D.GRUPO_CODIGO AS GRUPO_CODIGO,
    D.DESCRICAO_POPULAR_MATERIAL AS DESCRICAO_DEMANDA,
    D.QUANTIDADE AS QUANTIDADE,
    D.VALOR_TOTAL AS VALOR_TOTAL,
    D.DATA_COMPRA_CONTRATACAO AS DATA_DEMANDA,
    D.FK_RESPONSAVEL AS DIRETOR_RESPONSAVEL,
    D.FK_SOLICITANTE AS DEMANDANTE
FROM
    PAC_ASSINATURAS A
JOIN
    PAC_DEMANDA D ON D.ID_DEMANDA = A.FK_DEMANDA
WHERE (
    A.NIVEL = 1
    OR (
        A.NIVEL IN (2,3)
        AND NOT EXISTS (
            SELECT 1 AS EXISTE
            FROM PAC_ASSINATURAS A2
            WHERE A2.NIVEL = 1
            AND A2.SITUACAO = 1 -- AGUARDANDO
            AND A2.FK_DEMANDA = A.FK_DEMANDA -- AQUI ESTÁ O SEGREDO!
        )
    )
)
ORDER BY
    A.DATA_ENCAMINHAMENTO DESC,
    A.NIVEL ASC,
    A.ID_ASSINATURA ASC